#!/usr/bin/env python

import sys
import logging
import imp
from getopt import getopt, GetoptError

from subprocess import Popen, PIPE

logging.basicConfig(level=logging.INFO, filename='penchy_bootstrap.log')
log = logging.getLogger('penchy-bootstrap')


def maven_setup():
    log.debug("Executing mvn install:")
    proc = Popen(['mvn', '-f', 'bootstrap.pom', 'install'],
            stdout=PIPE, stderr=PIPE)
    stdout, _ = proc.communicate()  # Maven doesn't use stderr...
    log.debug(stdout)

    log.debug("Getting classpath")
    proc2 = Popen(['mvn', '-f', 'bootstrap.pom', 'dependency:build-classpath'],
            stdout=PIPE, stderr=PIPE)
    stdout, _ = proc2.communicate()
    for line in stdout.split("\n"):
        if not line.startswith("["):
            log.info("Classpath found at " + line)
            return line
    log.error("Classpath could not be determined")


def run(job):
    classpath = maven_setup()
    penchy_zip = filter(lambda x: x.endswith("zip"), classpath.split(":"))[0]
    log.info("Starting PenchY Client")

    sys.path.insert(0, penchy_zip)
    from penchy import client
    client.main(job)


def parse_args(argv):
    options, args = getopt(argv[1:], 'l:')
    loglevel = None
    for opt in options:
        if opt[0] == '-l':
            try:
                loglevel = getattr(logging, opt[1].upper())
            except AttributeError:
                pass

    job = imp.load_source('job', args[0])

    return (job, loglevel)


if __name__ == "__main__":
    try:
        (job, loglevel) = parse_args(sys.argv)
        if loglevel:
            logging.root.setLevel(loglevel)
        run(job)
    except Exception, err:
        log.exception('Exception occured while executing PenchY:')
        sys.exit(1)

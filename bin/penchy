#!/usr/bin/env python

import argparse
import logging
import sys
import os
import imp

from penchy import server
from penchy.server import Server


log = logging.getLogger(__name__)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description=server.__doc__)
    log_group = parser.add_mutually_exclusive_group()
    log_group.add_argument("-d", "--debug",
            action="store_const", const=logging.DEBUG,
            dest="loglevel", default=logging.INFO,
            help="print debugging messages")
    log_group.add_argument("-q", "--quiet",
            action="store_const", const=logging.WARNING,
            dest="loglevel", help="suppress most messages")
    parser.add_argument("-c", "--config",
            action="store", dest="config",
            default=os.path.expanduser("~/.penchyrc"),
            help="config module to use")
    parser.add_argument("-f", "--load-from",
            action="store", dest="load_from",
            help="load penchy from this path on the node")
    parser.add_argument("job", help="job to execute",
            metavar="job")
    args = parser.parse_args()
    logging.root.setLevel(args.loglevel)

    try:
        config = imp.load_source('Config', args.config)
    except IOError:
        try:
            config = imp.load_source('Config', 'penchyrc')
        except IOError:
            raise IOError("Config file could not be loaded from: %s or ./penchyrc" % args.config)

    log.info('Using %s config module' % config.__file__)

    server = Server(config, args.job)

    if args.load_from:
        server.bootstrap_args.extend(['--load-from', args.load_from])

    server.run()
